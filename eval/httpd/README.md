## Overview
We use VDom user-space APIs to protect each private key structure of the OpenSSL library, namely put each private key into a separate domain when allocation. 

To test VDom's performance overhead, we choose a popular web server 'httpd' linked with the original OpenSSL and protected OpenSSL library, and test the throughput drop of the server. The version we use: OpenSSL 3.0.1, httpd 2.4.52, ApacheBench 2.3. Note that we modified OpenSSL, while httpd code is not modified.

The following chapters introduce how to build and install OpenSSL and httpd, and how to use ApacheBench to test the throughput of the original and VDom protected httpd server. 

## File tree structure
We run httpd experiments on Intel X86 and ARM architectures. Since Intel and ARM memory domains vary in granularity (4KB on Intel, 2MB on ARM), OpenSSL library code on the two architectures has some minor differences when allocating domains for each private key. 

We provide source code of OpenSSL library of two versions: the unmodified (origin) version and the modified VDom protected version. Each architecture has its own source code of the modified VDom protected OpenSSL. 

The source code of httpd is also provided, which is the same on both architectures. 

The file tree structure is organised as follows:
- `httpd-src`: the source code of httpd, which is unmodifed. The code is applicable on both architectures.
- `openssl-src`
	- `origin`: the source code of unmodified OpenSSL. The code is applicable on both architectures.
	- `vdom`
		- `ARM`: the source code of modified VDom protected OpenSSL, which is applicable on ARM architectures.
		- `X86`: the source code of modified VDom protected OpenSSL, which is applicable on X86 architectures.
- `test`: contains scripts used to test the throughput of the original httpd and VDom protected httpd. Please refer to `README.md` under `test` to understand how to test and how to reproduce the results of our paper.

## Preliminary
Following packages are needed (You may also miss other packages, but that will be easy to resolve):
```
apt-get install libpcre3-dev expat libexpat1-dev apache2-utils parallel
```


## Build and install OpenSSL
The installation of OpenSSL is the same for all 3 versions of OpenSSL source code (original, VDom protected X86, VDom protected ARM), **except that** we need to modify the generated `Makefile` for VDom protected version in order to link the VDom user-space library.

Assume we want to install OpenSSL in the path `PREFIX-OPENSSL` (a directory named `openssl` is generated under `PREFIX-OPENSSL` after installation), run:
``` shell
# For example, to build original OpenSSL
# under openssl/src/origin
./Configure -Werror --strict-warnings \
            --openssldir=PREFIX-OPENSSL/openssl/ssl \
            --prefix=PREFIX-OPENSSL/openssl \
            '-Wl,-rpath,$(LIBRPATH)' \
```
**When building the VDom protected OpenSSL,** we need to modify `Makefile` generated by the above command. Search `EX_LIBS=` in the `Makefile`, modify as follows:
``` Makefile
EX_LIBS= -lvkeys -lpthread
```
to link to the VDom user-space library and pthread library. 

Then, run the following commands to install OpenSSL:
```shell
make -j
make install
```

After the installation, you will obtain installed OpenSSL in `PREFIX-OPENSSL/openssl`. You can check whether the library is correctly linked with VDom user-space library using the following command:
```shell
ldd PREFIX-OPENSSL/openssl/lib64/libssl.so.3
```

You may refer to the document for further advice: https://github.com/openssl/openssl/blob/openssl-3.0.1/INSTALL.md/.

## Build and install httpd
The installation of httpd is independent of OpenSSL and VDom user-space library. On one architecture, we only need to install one httpd distribution, while use the unmodified or modified OpenSSL libraries. 

Assume we want to install httpd in the path `PREFIX-HTTPD` (a directory named `httpd` is generated under `PREFIX-HTTPD` after installation):
``` shell
# under httpd-src/
./configure \
  --prefix=PREFIX-HTTPD/httpd \
  --enable-ssl=shared \
  --with-included-apr
make -j
make install
```

Now we can start httpd to test whether we install httpd correctly, assume we have installed OpenSSL in path `PREFIX-OPENSSL`:
```shell
sudo LD_LIBRARY_PATH="PREFIX-OPENSSL/openssl/lib64/" PREFIX-HTTPD/bin/apachectl -k start -X
```

Then, visit `http://localhost` in a browser to check. By default, httpd uses http connection.

You may refer to the document for further advice: https://httpd.apache.org/docs/2.4/install.html.

## Enable httpd SSL connection
We will set up SSL connection for httpd server in this chapter. 

### Generate self-signed private key and certificate
Use OpenSSL we have installed to generate self-signed private key and certificate (assume that private key and certificate are output to the directory `PREFIX-KEY-CERT`):
```shell
PREFIX-OPENSSL/openssl/bin/openssl req -x509 -nodes -days 365 -newkey rsa:1024 \
	-keyout PREFIX-KEY-CERT/apache-selfsigned.key \
  -out PREFIX-KEY-CERT/apache-selfsigned.crt \
```
Note that we only need one copy of private key and certificate file for httpd on one machine. 

### Revise `httpd.conf`
We need to revise the configuration file of httpd (`PREFIX-HTTPD/httpd/conf/httpd.conf`) to enable SSL connection. Uncomment the following lines (Note that line numbers may vary):
```
70  LoadModule authn_socache_module modules/mod_authn_socache.so
88  LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
134 LoadModule ssl_module modules/mod_ssl.so
146 LoadModule vhost_alias_module modules/mod_vhost_alias.so
460 Include conf/extra/httpd-mpm.conf
478 Include conf/extra/httpd-vhosts.conf
495 Include conf/extra/httpd-ssl.conf
```
Revise `ServarName` in line 195:
```
# before
#ServerName www.example.com:80
# after
ServerName localhost
```

### Revise `httpd-ssl.conf`
We need to revise file `PREFIX-HTTPD/httpd/conf/extra/httpd-ssl.conf`. Revise as following:
```
# before
121 <VirtualHost _default_:443>
125 ServerName www.example.com:443
144 SSLCertificateFile "PREFIX-HTTPD/httpd/dist/httpd/conf/server.crt"
154 SSLCertificateKeyFile "PREFIX-HTTPD/httpd/dist/httpd/conf/server.key"

# after
121 <VirtualHost *:443>
125 ServerName YOUR_IP_ADDRESS:443
144 SSLCertificateFile "PREFIX-KEY-CERT/apache-selfsigned.crt"
154 SSLCertificateKeyFile "PREFIX-KEY-CERT/apache-selfsigned.key"
```

### Revise `httpd-vhosts.conf`
We need to revise file `PREFIX-HTTPD/httpd/conf/extra/httpd-vhosts.conf`. Comment all the original contents and add the following lines:
```
<VirtualHost *:80>
  ServerName localhost
  Redirect / https://localhost/
</VirtualHost>
```

## Use ApacheBench (ab) to test httpd

### Launch httpd with designated OpenSSL
```shell
sudo LD_LIBRARY_PATH="PREFIX-OPENSSL/openssl/lib64/" \
	PREFIX-HTTPD/httpd/bin/apachectl \
	-k start -X
```
You may need to kill service or application occupying the 80 port.

### Use ab to test httpd with SSL connection
```
ab -c 4 -n 1000 https://localhost/
```
You may refer to the document for further advice: https://httpd.apache.org/docs/2.4/programs/ab.html.

## Modify configuration of httpd

### Config the file that ab requests
You can find the following lines in `PREFIX-HTTPD/httpd/conf/httpd.conf`:
```
<IfModule dir_module>
    DirectoryIndex index.html
</IfModule>
```

`index.html` is by default placed at `PREFIX-HTTPD/httpd/htdocs`. To use the test script we provide in `test` directory, you should change `index.html` to `test` as:
```
<IfModule dir_module>
    DirectoryIndex test
</IfModule>
```

### Change the thread number of a httpd process
By default, httpd use `Event` Multi-Processing Module (https://httpd.apache.org/docs/current/mod/event.html). We can change the number of threads a httpd process spawns (we change it to 40 as we stated in our paper). To do so, modify `PREFIX-HTTPD/httpd/conf/extra/httpd-mpm.conf`:
```
# before
<IfModule mpm_event_module>
    StartServers             3
    MinSpareThreads         75
    MaxSpareThreads        250
    ThreadsPerChild         25
    MaxRequestWorkers      400
    MaxConnectionsPerChild   0
</IfModule>

# after, assume a process spawns 40 threads
<IfModule mpm_event_module>
    StartServers             3
    MinSpareThreads         75
    MaxSpareThreads        250
    ThreadsPerChild         40
    MaxRequestWorkers      400
    MaxConnectionsPerChild   0
</IfModule>
```